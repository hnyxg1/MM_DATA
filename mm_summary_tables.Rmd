---
title: "Stratified Summary Tables of Multiple Myeloma Dataset"
author: "Xujun Gu"
date: "08-01-2025"
output:
  html_document: default
  pdf_document: default
editor_options:
  chunk_output_type: console
---

# Section 1. Stratified Analysis {.tabset}

Note:

Q: What is LDH Pretreatment Level?
A: LDH (Lactate Dehydrogenase) is a biomarker often used to assess tumor burden and aggressiveness in multiple myeloma (MM).

Q: What is “5 Schema Discriminator 1: Plasma Cell Myeloma Terminology coded to 1 or 9”.
A: This is a SEER variable used to clarify or “discriminate” between overlapping cancer schemas when a site/histology could fit multiple schemas. It can help for staging, coding, or analyzing a specific cancer. If it’s mostly in the bone marrow, it’s multiple myeloma (coded as 1). If plasma cells spill over into the blood, it's plasma cell leukemia (coded as 9). May need clinician for further explanation.

https://staging.seer.cancer.gov/eod_public/input/1.0/plasma_cell_myeloma/discriminator_1/?version=/eod_public/home/1.2/


## Overall Summary

```{r overall_code, echo=FALSE, message=FALSE}
library(tidyverse)
library(gtsummary)
source(paste0("code/00_project-setup.R"))
load(file = paste0(data_dir, "mm_data_extreme.RData"))

overall_table <- mm_data_extreme %>%
  tbl_summary(
    include = c(
      `Age at Diagnosis (Years)`, Sex, `Race 1`, `Marital Status 1`, `Marital Status 2`,
      Lymph_Node_Dissected_Flag,Diagnostic_Flag,Surgery1_Flag,Surgery2_Flag,Chemo_Flag,Radiation_Flag,Hormone_Flag,Immuno_Flag,Other_Treatment_Flag,Transplant_Flag, Treatment,`Insurance Type`,
      `Primary Payer at Diagnosis`, `High Risk Cytogenetics`,
      `LDH (Lactate Dehydrogenase) Pretreatment Level`,
      `Serum Beta-2 Microglobulin Pretreatment Level`, RISS, ISS
    ),
    statistic = list(
      all_continuous() ~ "{mean} (SD={sd}) ({min}, {max})",
      all_categorical() ~ "{n} /{N} ({p}%)"
    ),
    digits = all_categorical() ~ c(2, 0),
    missing_text = "(Missing)",
    type = all_dichotomous() ~ "categorical"
    ) %>%
  bold_labels() %>%
  modify_header(label ~ "**Variable**") %>%
  modify_caption("**Table 1. Overall Groups**")

overall_table
```



## High Risk Cytogenetics
```{r cyto-table, echo=FALSE}
cyto_table <- mm_data_extreme %>%
  tbl_summary(
    by = `High Risk Cytogenetics`,
    include = c(`Age at Diagnosis (Years)`, Sex, `Race 1`, `Marital Status 1`, `Marital Status 2`,Lymph_Node_Dissected_Flag,Diagnostic_Flag,Surgery1_Flag,Surgery2_Flag,Chemo_Flag,Radiation_Flag,Hormone_Flag,Immuno_Flag,Other_Treatment_Flag,Transplant_Flag,`Insurance Type`, `Primary Payer at Diagnosis`, RISS, ISS),
    digits = all_categorical() ~ c(0, 2),
    missing_text = "(Missing)",
    statistic = list(all_continuous() ~ "{mean} ({sd})"),
    type = all_dichotomous() ~ "categorical"
  ) %>%
  add_overall() %>%
  modify_header(label ~ "**Variable**") %>%
  bold_labels() %>%
  modify_caption("**Table 2.1. High Risk Cytogenetics**")

cyto_table
```


## LDH Pretreatment Level

```{r ldh-table, echo=FALSE}
LDH_level_table <- mm_data_extreme %>%
  tbl_summary(
    by = `LDH (Lactate Dehydrogenase) Pretreatment Level`,
    include = c(`Age at Diagnosis (Years)`, Sex, `Race 1`, `Marital Status 1`, `Marital Status 2`, Lymph_Node_Dissected_Flag,Diagnostic_Flag,Surgery1_Flag,Surgery2_Flag,Chemo_Flag,Radiation_Flag,Hormone_Flag,Immuno_Flag,Other_Treatment_Flag,Transplant_Flag,`Insurance Type`, `Primary Payer at Diagnosis`, RISS, ISS),
    digits = all_categorical() ~ c(0, 2),
    missing_text = "(Missing)",
    statistic = list(all_continuous() ~ "{mean} ({sd})"),
    type = all_dichotomous() ~ "categorical"
  ) %>%
  add_overall() %>%
  modify_header(label ~ "**Variable**") %>%
  bold_labels() %>%
  modify_caption("**Table 2.2. LDH Pretreatment Level**")

LDH_level_table
```


## Serum Beta-2 Microglobulin Level

```{r serum-table, echo=FALSE}
Serum_table <- mm_data_extreme %>%
  tbl_summary(
    by = `Serum Beta-2 Microglobulin Pretreatment Level`,
    include = c(`Age at Diagnosis (Years)`, Sex, `Race 1`,`Marital Status 1`, `Marital Status 2`, Lymph_Node_Dissected_Flag,Diagnostic_Flag,Surgery1_Flag,Surgery2_Flag,Chemo_Flag,Radiation_Flag,Hormone_Flag,Immuno_Flag,Other_Treatment_Flag,Transplant_Flag, `Insurance Type`, `Primary Payer at Diagnosis`, RISS, ISS),
    digits = all_categorical() ~ c(0, 2),
    missing_text = "(Missing)",
    statistic = list(all_continuous() ~ "{mean} ({sd})"),
    type = all_dichotomous() ~ "categorical"
  ) %>%
  add_overall() %>%
  modify_header(label ~ "**Variable**") %>%
  bold_labels() %>%
  modify_caption("**Table 2.3. Serum Beta-2 Microglobulin Pretreatment Level**")

Serum_table
```




## SCT
```{r ruoyi1, echo=FALSE}
SCT <- mm_data_extreme %>%
  tbl_summary(
    by = `Transplant_Flag`,
    include = c(`Age at Diagnosis (Years)`,age_cat, Sex, `Race 1`,`Marital Status 1`, `Marital Status 2`, `Insurance Type`, `Primary Payer at Diagnosis`, `High Risk Cytogenetics`,`LDH (Lactate Dehydrogenase) Pretreatment Level`,`Serum Beta-2 Microglobulin Pretreatment Level`, RISS, ISS),
    digits = all_categorical() ~ c(0, 2),
    missing_text = "(Missing)",
    statistic = list(all_continuous() ~ "{mean} ({sd})"),
    type = all_dichotomous() ~ "categorical"
  ) %>%
  add_overall() %>%
  modify_header(label ~ "**Variable**") %>%
  bold_labels() %>%
  modify_caption("**Table 2.4 Ruoyi_table_check_SCT**") %>% 
  add_p()

SCT
```


## Race
```{r race_1, echo=FALSE}
Race <- mm_data_extreme %>%
  tbl_summary(
    by = `Race 1`,
    include = c(`Age at Diagnosis (Years)`,age_cat, Sex,`Marital Status 1`, `Marital Status 2`, `Insurance Type`, `Primary Payer at Diagnosis`, `High Risk Cytogenetics`,`LDH (Lactate Dehydrogenase) Pretreatment Level`,`Serum Beta-2 Microglobulin Pretreatment Level`, Lymph_Node_Dissected_Flag,Diagnostic_Flag,Surgery1_Flag,Surgery2_Flag,Chemo_Flag,Radiation_Flag,Hormone_Flag,Immuno_Flag,Other_Treatment_Flag,Transplant_Flag, Treatment, , RISS, ISS),
    digits = all_categorical() ~ c(0, 2),
    missing_text = "(Missing)",
    statistic = list(all_continuous() ~ "{mean} ({sd})"),
    type = all_dichotomous() ~ "categorical"
  ) %>%
  add_overall() %>%
  modify_header(label ~ "**Variable**") %>%
  bold_labels() %>%
  modify_caption("**Table 2.5 Race Stratified Table**") %>% 
  add_p()

Race
```



# Logistic Regression {.tabset}

Running logistic regression for all different treatement to see the difference

## SCT
``` {r SCT}
mm_data_extreme <- mm_data_extreme %>%
  mutate(Transplant_bin = ifelse(Transplant_Flag == "Yes", 1, 0),
         Surgery1_bin = ifelse(Surgery1_Flag == "Yes", 1, 0),
         Surgery2_bin = ifelse(Surgery2_Flag == "Yes", 1, 0),
         Chemo_bin = ifelse(Chemo_Flag == "Yes", 1, 0),
         Radiation_bin = ifelse(Radiation_Flag == "Yes", 1, 0),
         Hormone_bin = ifelse(Hormone_Flag == "Yes", 1, 0),
         Immuno_bin = ifelse(Immuno_Flag == "Yes", 1, 0),
         Sex_bin = ifelse(Sex == "Male" , 1, 0))

mm_data_extreme$`Race 1` <- relevel(factor(mm_data_extreme$`Race 1`), ref = "White")

model_SCT <- glm(Transplant_bin ~ Sex_bin +`Race 1`+ `Insurance Type` + `Marital Status 1` + `Spanish Origin`+`Family Cancer History` + `Serum Beta-2 Microglobulin Pretreatment Level`, data = mm_data_extreme, family = binomial)

model_SCT %>%
  tbl_regression(exponentiate = FALSE)
```

## Chemo
```{r Chemo}

model_Chemo <- glm( Chemo_bin ~ Sex_bin +`Race 1`+ `Insurance Type` + `Marital Status 1` + `Spanish Origin`+`Family Cancer History` + `Serum Beta-2 Microglobulin Pretreatment Level`, data = mm_data_extreme, family = binomial)

model_Chemo %>%
  tbl_regression(exponentiate = FALSE)
```


## Immuno
```{r Immuno}
Immuno_bin <- glm( Immuno_bin ~ Sex_bin +`Race 1`+ `Insurance Type` + `Marital Status 1` + `Spanish Origin`+`Family Cancer History` +`Serum Beta-2 Microglobulin Pretreatment Level`, data = mm_data_extreme, family = binomial)

Immuno_bin %>%
  tbl_regression(exponentiate = FALSE)
```


## Hormone
```{r Im}
Hormone_bin <- glm( Hormone_bin ~ Sex_bin +`Race 1`+ `Insurance Type` + `Marital Status 1` + `Spanish Origin`+`Family Cancer History` + `LDH (Lactate Dehydrogenase) Pretreatment Level`+`Serum Beta-2 Microglobulin Pretreatment Level`, data = mm_data_extreme, family = binomial)

Hormone_bin %>%
  tbl_regression(exponentiate = FALSE)
```

# Treatment Data list

1. Radiation Therapy
Reason for No Radiation
Summary of Therapy gives the information on whether patients received the Radiation Therapy or not.
Comments – Radiation Treatment
Date Radiation Started
Date Radiation Ended

2. Chemotherapy
Date of First Chemotherapy
Chemotherapy 
Comments – Chemotherapy Treatment

3. Surgery
Date of Surgical Diagnostic and Staging Procedure (Diagnostic)
Date of Surgery

4. Hormone (Corticosteroid) Therapy
Date of First Hormone Therapy
Comments – Hormone Treatment
		
5. Immunotherapy / Biologic Therapy
Date of First Immunotherapy
Immunotherapy
Comments – Immunotherapy Treatment

6. Hematologic Transplant / Endocrine Procedure
Date of Hematologic Transplant/Endocrine Procedure

7. “Other” Therapy
Date Other Treatment Started
Other Treatment
Comments – Other Treatment




#Data Visualization (example)

``` {r Data visualzation}
pie_race <- mm_data_extreme %>%
  count(`Race 1`) %>%
  mutate(percent = n / sum(n) * 100)
  
library(ggplot2)
ggplot(pie_race, aes(x = "", y = percent, fill = `Race 1`)) +
  geom_bar(width = 1, stat = "identity") +
  coord_polar(theta = "y") +                
  labs(fill = "Race") +
  theme_void()

ggplot(mm_data_extreme, aes(x = `Primary Payer at Diagnosis`, fill = `Race 1`)) +
  geom_bar(position = "dodge") +
  labs(
    title = "Count of Insurance Type by Race",
    x = "Insurance Type",
    y = "Number of Patients",
    fill = "Race"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))  

``` 

